#!/bin/bash

set -xeo pipefail

LOCAL_SOURCE_DIR=${HOME}


if [ "$IS_UNIT_TESTER" = "true" ]; then
    LOCAL_IP=`hostname -I`
    cat  $LOCAL_SOURCE_DIR/wildfly/standalone.xml | sed s/"\${PIM_REF_DB_HOST}"/$PIM_REF_DB_HOST/g  > /wildfly/standalone/configuration/standalone-s2i.xml
    exec /wildfly/bin/standalone.sh  --server-config=standalone-s2i.xml $JVM_ARGS -DLDAP_HOST=$LDAP_HOST -DPIM_ADMIN_DB=$PIM_ADMIN_DB -DPIM_ROOT_DB=$PIM_ROOT_DB -DPIM_REF_DB_NAME=$PIM_REF_DB_NAME -DPIM_REF_DB_USER=$PIM_REF_DB_USER -DPIM_DB_USER=$PIM_DB_USER -DPIM_DB_PASSWORD=$PIM_DB_PASSWORD -DPIM_REF_DB_PASSWORD=$PIM_REF_DB_PASSWORD -DEMBED_APACHEDS_LDAP=true -DENABLE_REDIS_SESSION=false -DLOCAL_IP=$LOCAL_IP
else
#this while loop means that deployment will stall (because the health check will fail unit HBEE starts up)
#we want this so that Ops makes sure to set the standalone.xml configuration file manually. 
    while [ ! -f /opt/hummingbird/s2i/standalone.xml.src ]
    do
	sleep 10
	echo "waiting for file /opt/hummingbird/s2i/standalone.xml.src to magically appear in the mounted vollume..."
    done
    cp  /opt/hummingbird/s2i/standalone.xml.src /wildfly/standalone/configuration/standalone-s2i.xml
    exec /wildfly/bin/standalone.sh -b 0.0.0.0 -bmanagement 0.0.0.0 --server-config=standalone-s2i.xml $JVM_ARGS  -DREDIS_HOST=$REDIS_HOST -DREDIS_PORT=$REDIS_PORT
fi



